<api context="/HelloWorld" name="HelloWorld" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET">
        <inSequence>

            <!-- Get environment variables -->
            <property expression="get-property('env', 'TOKEN_URL')" name="uri.var.token_url" scope="default" type="STRING"/>
            <property expression="get-property('env', 'CONSUMER_KEY')" name="consumer_key" scope="default" type="STRING"/>
            <property expression="get-property('env', 'CONSUMER_SECRET')" name="consumer_secret" scope="default" type="STRING"/>
            <property expression="get-property('env', 'SVC_URL')" name="uri.var.service_url" scope="default" type="STRING"/>

            <!-- Log environment variables -->
            <log level="custom">
                <property name="Token URL" expression="get-property('uri.var.token_url')"/>
                <property name="Consumer Key" expression="get-property('consumer_key')"/>
                <property name="Consumer Secret" expression="get-property('consumer_secret')"/>
                <property name="Service URL" expression="get-property('uri.var.service_url')"/>
            </log>

            <!-- Set Authorization and Content-Type headers for token request -->
            <property name="Authorization" expression="fn:concat('Basic ', base64Encode(fn:concat(get-property('consumer_key'), ':', get-property('consumer_secret'))))" scope="transport"/>
            <property name="messageType" value="application/x-www-form-urlencoded" scope="axis2"/>
            <header name="Content-Type" value="application/x-www-form-urlencoded" scope="transport"/>

            <!-- Token request body -->
            <payloadFactory media-type="xml">
                <format>
                    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
                        <soapenv:Body>
                            <root xmlns="">
                                <grant_type>client_credentials</grant_type>
                            </root>
                        </soapenv:Body>
                    </soapenv:Envelope>
                </format>
                <args />
            </payloadFactory>

            <!-- Make token request -->
            <call blocking="true">
                <endpoint>
                    <http method="POST" uri-template="{uri.var.token_url}"/>
                </endpoint>
            </call>

            <!-- Log token call response -->
            <property name="token_call_status" expression="get-property('axis2', 'HTTP_SC')" scope="default"/>
            <log level="custom">
                <property name="Token Call HTTP Status" expression="get-property('token_call_status')"/>
                <property name="Token Endpoint Response" expression="get-property('body')"/>
            </log>

            <!-- Extract access token -->
            <property name="access_token" expression="json-eval($.access_token)" scope="default"/>
            <log level="custom">
                <property name="Extracted Access Token" expression="get-property('access_token')"/>
            </log>

            <!-- Set Authorization header for actual service call -->
            <header name="Authorization" expression="fn:concat('Bearer ', get-property('access_token'))" scope="transport"/>

            <!-- Call the actual service -->
            <call blocking="true">
                <endpoint>
                    <http method="GET" uri-template="{uri.var.service_url}/greeting"/>
                </endpoint>
            </call>

            <!-- Log service response -->
            <log level="full">
                <property name="Service Response" expression="get-property('body')"/>
            </log>

            <respond/>

        </inSequence>
        <outSequence/>
        <faultSequence/>
    </resource>
</api>
